# DNS解析(递归解析和迭代解析)

## 域名结构

![](/home/xsh/桌面/markdown/imgs/20140506151600093.png)、

这是中央电视台用于手法电子邮件的计算机的域名，它由三个标号组成，其中标号com是顶级域名，标号cctv是二级域名，标号mail是三级域名。DNS规定，域名中的标号都有英文和数字组成，每一个标号不超过63个字符(为了记忆方便，一般不会超过12个字符)，也不区分大小写字母。标号中除连字符(-)外不能使用其他的标点符号。级别最低的域名写在最左边，而级别最高的字符写在最右边。由多个标号组成的完整域名总共不超过255个字符。DNS既不规定一个域名需要包含多少个下级域名，也不规定每一级域名代表什么意思。各级域名由其上一级的域名管理机构管理，而最高的顶级域名则由ICANN进行管理。用这种方法可使每一个域名在整个互联网范围内是唯一的，并且也容易设计出一种查找域名的机制。

​        域名只是逻辑概念，并不代表计算机所在的物理地点。据2006年12月统计，现在顶级域名TLD(Top Level Domain)已有265个，分为三大类：

​        (1)国家顶级域名nTLD：采用ISO3166的规定。如：cn代表中国，us代表美国，uk代表英国，等等。国家域名又常记为ccTLD(cc表示国家代码contry-code)。

​        (2)通用顶级域名gTLD：最常见的通用顶级域名有7个，即：com(公司企业)，net(网络服务机构)，org(非营利组织)，int(国际组织)，gov(美国的政府部门)，mil(美国的军事部门)。

​        (3)基础结构域名(infrastructure domain)：这种顶级域名只有一个，即arpa，用于反向域名解析，因此称为反向域名。

![](/home/xsh/桌面/markdown/imgs/20140506153156531.png)



## DNS：Domain Name System（域名服务系统）

DNS的常见用法：将服务器名称和 IP 地址进行关联,但它还可以将邮件地址和邮件服务器进行关联,以及为各种信息关联相应的名称。

**为什么需要ip地址**(域名->实体ip)

 TCP/IP 网络是通过 IP 地址来确定通信对象的，不知道 IP 地址就无法将消息发送给对方，因此，在委托操作系统发送消息时，必须要先查询好对方 的 IP 地址。

如果 Web 服务器使用了虚拟主机功能,有可能无法通过 IP 地址来访问。因为虚拟主机是寄存在服务器上的一个或多个没有实体的服务器，访问虚拟主机的域名的时候，先根据DNS解析的IP访问到实体主机，然后实体主机再根据域名把连接转发给对应的虚拟主机，DNS解析的IP只是实体主机的IP（并不是要访问的web应用服务器IP地址）。

**域名和 IP 地址并用的理由**

- 不用IP 地址，而是用名称来确定通信对象?
  IP 地址的长度 为 32 比特（ 4 字节），使用域名最少也要几十个字节，最长可达到255字节，增加了路由器的负担,传送数据也会花费更长的时间 ，运行效率较低。（路由转发包传输数据）
- 浏览器网址中不写服务器的名字，直接写IP 地址?
  用IP地址来代替服务器名称也是能够正常工作的 。然而,要记住一串由数字组成的 IP 地址也非常困难
- 让人来使用名称,让路由器来使用IP地址。
  为了填补两者之间的障碍,需要有一个机制能够通过名称来查询IP地址,或者通过IP 地址来查询名称,这个机制就是DNS

**TCP/IP 的结构**



![](/home/xsh/桌面/markdown/imgs/f965de9b8c67bb2db138d0b785a5c124.png)

**实际的IP地址**

在 IP 地址的规则中,网络号和主机号连起来总共 32 比特,但这两部分的具体结构是不固定的（在组建网络时,用户可以自行决定它们之间的分配关系），无法区分哪部分是网络号,哪部分是主机号。因此：需要另外的附加信息来表示 IP 地址的内部结构。这就需要用到子网掩码，子网掩码的格式是一 串与IP地址长度相同的32比特数字,左边一半都是1，右边一半都是0。子网掩码为1的部分表示网络号，子网掩码为0的部分表示主机号。

IP 地址的主机号：

- 全 0：表示整个子网
- 全 1：表示向子网上所有设备发送包，即“广播”



![](/home/xsh/桌面/markdown/imgs/fb229b38b1b32c2e003950c5c7447c3f.png)



## **浏览器是如何向 DNS 服务器发出查询**

- 浏览器搜索自身的DNS缓存：
  首先浏览器会去搜索自身的DNS缓存，看缓存有没有过期，过期的话缓存的解析就结束了（chrome缓存的时间只有一分钟，查看chrome的缓存可打开：chrome://net-internals/#dns ）。
- 搜索操作系统自身的DNS缓存：
  如果浏览器没有找到缓存或者缓存过期失效，浏览器就会搜索操作系统自身的缓存，没有找到或者失效，解析结束（操作系统的缓存：window系统是一天，mac系统严格根据DNS协议中的TTL）。
- 读取本地的hosts文件：
  若操作系统的缓存也没有找到或失效，浏览器就会去读取本地的hosts文件（Hosts文件也可以建立域名到IP地址的绑定关系，可以通过编辑Hosts文件来达到名称解析的目的。 例如，我们需要屏蔽某个域名时，就可以将其地址指向一个不存在IP地址，以达到屏蔽的效果）。
- 浏览器发起一个DNS的系统调用：
  hosts中没有找到对应的配置项的话，浏览器发起一个DNS的调用（向本地主控DNS服务，一般来说是你的运营商提供的）。

## **解析器与DNS服务器之间的交互过程**

通过 DNS 查询 IP 地址的操作称为域名解析，负责执行解析这一操作的就叫解析器。 解析器实际上是一段程序,它包含在操作系统的 Socket 库中 （Socket 库可以让其他的应用程序调用操作系统的网络功能 ）。

通过 DNS 查询 IP 地址的操作称为域名解析，负责执行解析这一操作的就叫解析器。 解析器实际上是一段程序,它包含在操作系统的 Socket 库中 （Socket 库可以让其他的应用程序调用操作系统的网络功能 ）。

解析器的用法非常简单，编写应用程序（这里也就是指浏览器）时，如下图写上解析器的程序名称（gethostbyname）以及web服务的域名([http://www.lab.glasscom.com/](https://link.juejin.im/?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttp%253A%2F%2Fwww.lab.glasscom.com%2F))进行调用就可以了，这样就完成了对解析器的调用。

![](/home/xsh/桌面/markdown/imgs/8bc1133682c745c4b6df2bacda34da13.png)

整个解析器的工作流程图：



![](/home/xsh/桌面/markdown/imgs/3f8bc3470b99a022a14c1a558094e85f.png)

- 调用解析器后,解析器会向 DNS 服务器（运营商提供的）发送查询消息。
- 运营商服务会先查找自身缓存找到对应条目，没有过期，解析成功，若没找到对应条目，主控服务器会代替浏览器发起一个迭代的DNS解析的请求，先查找根域的），运营商服务器拿到域名的IP，返回给操作系统的内核，同时缓存在了自己的缓存区，操作系统内核从DNS服务商拿来的IP地址返回给浏览器。
- 浏览器再向 Web 服务器发送消息时,只要从该内存地址取出 IP地址,将它与 HTTP 请求消息一起交给操作系统 .

TIP：向 DNS 服务器发送消息时,我们当然也需要知道 DNS 服务器的 IP 地址。只不过这个 IP 地址是作为 TCP/IP 的一个设置项目事先设 置好的,不需要再去查询了。

**DNS服务器的基本工作**

DNS 服务器的基本工作就是接收来自客户端的查询消息,然后根据消息的内容返回响应

 **来自客户端的查询消息包含以下 3 种信息**

- **域名**：服务器、邮件服务器(邮件地址中@后面的部分)的名称 。
- **Class**：用来识别网络的信息（在最早设计 DNS 方案时，DNS 在互联网以外的其他网络中的应用也被考虑到了。不过,如今除了互联网并没有其他的网络了，因此 Class 的值永远是代表互联网的 IN ）。
- **记录类型** ：表示域名对应何种类型的记录（例如，A ：表示域名对应的是 IP 地址,MX ：表示域名对应的是邮件服务器。对于不同的记录类型,服务器向客户端返回的信息也会不同 ）。

DNS 服务器上事先保存有前面这 3 种信息对应的记录数据，DNS 服务器的基本工作就是根据需要查询的：域名和记录类型查找相关的记录，并向客户端返回响应消息。

![](/home/xsh/桌面/markdown/imgs/f24557a389aecb15871c37ba88f2d322.png)

**DNS服务上的信息是如何在 DNS 服务器上注册并保存的**

DNS 服务器中的所有信息都是按照域名以分层次的结构来保存的，层次有点号来划分：主机名.次级域名.顶级域名.根域名（host.sld.tld.root），越靠近右边级别越高，所有域名后面都是带有根域的，但是一般都省略掉了。

![](/home/xsh/桌面/markdown/imgs/20fe9144d90bf52947661095c532e04a.png)

次级域名域名是用户可以注册的，再下一级是主机名（host），又称为"三级域名"，这是用户在自己的域里面为服务器分配的名称，是用户可以任意分配的。

前面说过若运营商服务里没有找到对应的条目，就会发起一个DNS迭代请求，首先就是查找根域服务器，那么运营商的服务了一定要保存有根域服务的IP地址。因为全球共有13台根逻辑域名服务器：A-M，2014年统计的真实的根服务器有386台，将根域的 DNS 服务器信息保存在互联网中所有的 DNS 服务器中也不是什么难事。如何实现呢：根域 DNS 服务器的相关信息已经包含在 DNS 服务器程序的配置文件中了,因此只要安装了 DNS 服务器程序,这些信息也就被自动配置好了。



**运营商DSN服务器发起的迭代请求** 

首先运营商服务从已经配置好的信息中拿到根域名的IP地址（这里假设根域只有一个，实际是想13个根域发起请求），然后像根域发起请求群问:"请问[http://www.lab.glasscom.com](https://link.juejin.im/?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttp%253A%2F%2Fwww.lab.glasscom.com)的IP地址是多少？"，根域名查询记录数据后没有找到，回答："我不知道它的IP地址，不过我知道.com的权威服务器（ns)的地址，它是xxx.xxx.xxx.xxx,你去问它吧"。运营商服务运营商服务拿到.com的IP地址，根据IP地址发起另一个请求去询问.com服务器问："请问 [http://www.lab.glasscom.com](https://link.juejin.im/?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttp%253A%2F%2Fwww.lab.glasscom.com)的ns的IP地址是多少？"，.com域服务器查找自身记录数据后回答：“我不知道，我只知道.[http://glasscom.com](https://link.juejin.im/?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttp%253A%2F%2Fglasscom.com)的IP地址”。 以此类推,只要重复前面的步骤,就可以顺藤摸瓜找到目标DNS服务器,只要向目标DNS 服务器发送查询消息,就能够得到我们需要的答案,也就是 [http://www.lab.glasscom.com](https://link.juejin.im/?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttp%253A%2F%2Fwww.lab.glasscom.com) 的 IP 地址了。

![](/home/xsh/桌面/markdown/imgs/4a7272eece69ba412d93a37526c65262.png)

**通过缓存加快 DNS 服务器的响应**

- 真实互联网中：一台 DNS 服务器可以管理多个域的信息,上下级域共享同一 台 DNS 服务器，访问上级 DNS 服务器时就可以向下跳过一级 DNS 服务器,直接返回再下一级 DNS 服务器的相关信息。
- DNS 服务器有缓存功能：并不需要从根域开始查找，通过缓存可以直接返回响应,接下来的查询可以从缓存的位置开始向下进行。相比每次都从根域找起来说,缓存可以减少查询所需的时间。
- 信息被缓存后,原本的注册信息可能会发生改变,这时缓存中的信息就有可能是不正确的，因此缓存信息会设置有效期，当缓存中的信息超过有效期后,数据就会从缓存中删除。

## **递归查询和迭代查询的区别**

![](/home/xsh/桌面/markdown/imgs/20140507124241312.png)



1）递归查询
递归查询是一种DNS 服务器的查询模式，在该模式下DNS 服务器接收到客户机请求，必须使用一个准确的查询结果回复客户机。如果DNS 服务器本地没有存储查询DNS 信息，那么该服务器会询问其他服务器，并将返回的查询结果提交给客户机。
（2）迭代查询
DNS 服务器另外一种查询方式为迭代查询，DNS 服务器会向客户机提供其他能够解析查询请求的DNS 服务器地址，当客户机发送查询请求时，DNS 服务器并不直接回复查询结果，而是告诉客户机另一台DNS 服务器地址，客户机再向这台DNS 服务器提交请求，依次循环直到返回查询的结果

 下面举一个例子演示整个查询过程：

​        假定域名为m.xyz.com的主机想知道另一个主机y.abc.com的IP地址。例如，主机m.xyz.com打算发送邮件给y.abc.com。这时就必须知道主机y.abc.com的IP地址。下面是上图a的几个查询步骤：

​        1、主机m.abc.com先向本地服务器dns.xyz.com进行递归查询。

​        2、本地服务器采用迭代查询。它先向一个根域名服务器查询。

​        3、根域名服务器告诉本地服务器，下一次应查询的顶级域名服务器dns.com的IP地址。

​        4、本地域名服务器向顶级域名服务器dns.com进行查询。

​        5、顶级域名服务器dns.com告诉本地域名服务器，下一步应查询的权限服务器dns.abc.com的IP地址。

​        6、本地域名服务器向权限域名服务器dns.abc.com进行查询。

​        7、权限域名服务器dns.abc.com告诉本地域名服务器，所查询的主机的IP地址。

​        8、本地域名服务器最后把查询结果告诉m.xyz.com。

### 两者间区别

​      递归查询过程中查询的主体发生了交换，而迭代查询过程中主体保持不变。至于两种查询哪种效率高，还得依据实际工程来取舍









 